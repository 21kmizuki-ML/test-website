<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>GAS è¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
<style>
  body{ font-family:monospace; padding:20px; background:#111; color:#eee; font-size:14px; }
  h1{ color:#f0c040; }
  .section{ margin:20px 0; border:1px solid #444; border-radius:6px; overflow:hidden; }
  .section-title{ background:#222; padding:10px 14px; font-weight:bold; color:#adf; font-size:1rem; }
  .row{ display:flex; align-items:center; gap:10px; padding:10px 14px; border-top:1px solid #333; }
  label{ width:220px; color:#ccc; }
  button{ padding:6px 14px; background:#003366; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9rem; }
  button:hover{ background:#0055aa; }
  .result{ flex:1; padding:8px 12px; background:#1a1a1a; border-radius:4px; color:#7f7; font-size:0.82rem; overflow-wrap:anywhere; max-height:120px; overflow-y:auto; }
  .result.error{ color:#f77; }
  .result.warn{ color:#fa7; }
  input[type=text]{ padding:6px 10px; background:#222; color:#eee; border:1px solid #555; border-radius:4px; width:200px; }
  .status{ display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:6px; vertical-align:middle; }
  .ok{ background:#4f4; }
  .ng{ background:#f44; }
  .pending{ background:#fa4; }
  .tip{ background:#223; border-left:4px solid #f0c040; padding:10px 14px; margin:14px 0; font-size:0.85rem; line-height:1.8; color:#ffc; }
  .url-display{ word-break:break-all; color:#adf; font-size:0.8rem; padding:8px 14px; background:#1a1a2e; }
</style>
</head>
<body>

<h1>ğŸ”¬ GAS è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>

<div class="tip">
  â‘  ã“ã®ãƒšãƒ¼ã‚¸ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦é–‹ãã‹ã€<br>
  â‘¡ ãƒ–ãƒ©ã‚¦ã‚¶ã§ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã€ã§ç›´æ¥é–‹ã„ã¦ãã ã•ã„ã€‚<br>
  å„ãƒœã‚¿ãƒ³ã‚’ä¸Šã‹ã‚‰é †ã«æŠ¼ã—ã¦ã€ã™ã¹ã¦ç·‘ã«ãªã‚Œã°æ­£å¸¸ã§ã™ã€‚
</div>

<!-- GAS URL è¨­å®š -->
<div class="section">
  <div class="section-title">âš™ï¸ GAS URL è¨­å®š</div>
  <div class="row">
    <label>ãƒ‡ãƒ—ãƒ­ã‚¤ URL</label>
    <input type="text" id="gas-url" 
      value="https://script.google.com/macros/s/AKfycbwSn6NRczBSietv9pIPXnKXxc5XiobGurw_9gqTFXvjUqNT4l4PkBJ4f1PVNwfw6hTUnw/exec"
      style="width:500px;">
    <button onclick="saveUrl()">ã‚»ãƒƒãƒˆ</button>
  </div>
  <div class="url-display" id="url-display">â€”</div>
</div>

<!-- ãƒ†ã‚¹ãƒˆ1: ç–é€šç¢ºèª -->
<div class="section">
  <div class="section-title">1ï¸âƒ£ GAS ç–é€šç¢ºèªï¼ˆGET ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰</div>
  <div class="row">
    <label>GAS ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹</label>
    <button onclick="testGet()">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    <div class="result" id="r-get">â€”</div>
  </div>
</div>

<!-- ãƒ†ã‚¹ãƒˆ2: è¨˜äº‹å–å¾— -->
<div class="section">
  <div class="section-title">2ï¸âƒ£ å…¬é–‹è¨˜äº‹å–å¾—ï¼ˆgetPublicArticlesï¼‰</div>
  <div class="row">
    <label>index.html / news.html ã§ä½¿ç”¨</label>
    <button onclick="testPost('getPublicArticles','r-articles')">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    <div class="result" id="r-articles">â€”</div>
  </div>
</div>

<!-- ãƒ†ã‚¹ãƒˆ3: æ¥­ç¸¾å–å¾— -->
<div class="section">
  <div class="section-title">3ï¸âƒ£ ç ”ç©¶æ¥­ç¸¾å–å¾—ï¼ˆgetPublicPublicationsï¼‰</div>
  <div class="row">
    <label>achievements.html ã§ä½¿ç”¨</label>
    <button onclick="testPost('getPublicPublications','r-pubs')">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    <div class="result" id="r-pubs">â€”</div>
  </div>
</div>

<!-- ãƒ†ã‚¹ãƒˆ4: ãƒ¡ãƒ³ãƒãƒ¼å–å¾— -->
<div class="section">
  <div class="section-title">4ï¸âƒ£ ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ï¼ˆgetPublicMembersï¼‰</div>
  <div class="row">
    <label>members.html ã§ä½¿ç”¨</label>
    <button onclick="testPost('getPublicMembers','r-members')">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    <div class="result" id="r-members">â€”</div>
  </div>
</div>

<!-- ãƒ†ã‚¹ãƒˆ5: OTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ -->
<div class="section">
  <div class="section-title">5ï¸âƒ£ OTP é€ä¿¡ãƒ†ã‚¹ãƒˆï¼ˆç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ Step 1ï¼‰</div>
  <div class="row">
    <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
    <input type="text" id="test-name" placeholder="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®Aåˆ—ã®åå‰">
  </div>
  <div class="row">
    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
    <input type="text" id="test-pw" placeholder="Cåˆ—ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button onclick="testOtpRequest()">OTPé€ä¿¡ãƒ†ã‚¹ãƒˆ</button>
    <div class="result" id="r-otp-req">â€”</div>
  </div>
</div>

<!-- ãƒ†ã‚¹ãƒˆ6: OTPæ¤œè¨¼ -->
<div class="section">
  <div class="section-title">6ï¸âƒ£ OTP æ¤œè¨¼ãƒ†ã‚¹ãƒˆï¼ˆç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ Step 2ï¼‰</div>
  <div class="row">
    <label>å—ä¿¡ã—ãŸOTPã‚³ãƒ¼ãƒ‰</label>
    <input type="text" id="test-otp" placeholder="6æ¡ã®æ•°å­—">
    <button onclick="testOtpVerify()">æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</button>
    <div class="result" id="r-otp-verify">â€”</div>
  </div>
</div>

<!-- çµæœã‚µãƒãƒªãƒ¼ -->
<div class="section">
  <div class="section-title">ğŸ“‹ è¨ºæ–­ã‚µãƒãƒªãƒ¼</div>
  <div class="row" style="display:block; padding:14px;">
    <div id="summary" style="line-height:2.2; font-size:0.9rem; color:#ccc;">
      ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã“ã«è¨ºæ–­çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    </div>
  </div>
</div>

<script>
let GAS_URL = document.getElementById('gas-url').value;

function saveUrl(){
  GAS_URL = document.getElementById('gas-url').value.trim();
  document.getElementById('url-display').textContent = GAS_URL;
}
saveUrl();

const results = {};

function setResult(id, text, type='ok'){
  const el = document.getElementById(id);
  el.textContent = text;
  el.className = 'result ' + (type === 'ok' ? '' : type);
  results[id] = { text, type };
  updateSummary();
}

function updateSummary(){
  const checks = [
    { id:'r-get',       label:'GASç–é€š' },
    { id:'r-articles',  label:'è¨˜äº‹å–å¾—' },
    { id:'r-pubs',      label:'æ¥­ç¸¾å–å¾—' },
    { id:'r-members',   label:'ãƒ¡ãƒ³ãƒãƒ¼å–å¾—' },
    { id:'r-otp-req',   label:'OTPé€ä¿¡' },
    { id:'r-otp-verify',label:'OTPæ¤œè¨¼' },
  ];
  let html = '';
  checks.forEach(c=>{
    const r = results[c.id];
    if(!r){ html += `<span class="status pending"></span>${c.label}: æœªãƒ†ã‚¹ãƒˆ<br>`; return; }
    const cls = r.type === 'ok' ? 'ok' : (r.type === 'warn' ? 'pending' : 'ng');
    html += `<span class="status ${cls}"></span>${c.label}: ${r.text.substring(0,80)}<br>`;
  });
  document.getElementById('summary').innerHTML = html || 'â€”';
}

/* ===== GET ãƒ†ã‚¹ãƒˆ ===== */
async function testGet(){
  setResult('r-get','å®Ÿè¡Œä¸­...','warn');
  try{
    const r = await fetch(GAS_URL, { redirect:'follow' });
    const text = await r.text();
    if(r.ok){
      setResult('r-get', `âœ… HTTP ${r.status} â€” GASã«åˆ°é”ã§ãã¾ã™ï¼ˆ${text.substring(0,50)}...ï¼‰`,'ok');
    } else {
      setResult('r-get', `âš ï¸ HTTP ${r.status} â€” ${text.substring(0,100)}`,'warn');
    }
  }catch(e){
    setResult('r-get', `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}\nâ†’ CORS or URLå•é¡Œã®å¯èƒ½æ€§`, 'error');
  }
}

/* ===== POST ãƒ†ã‚¹ãƒˆå…±é€š ===== */
async function testPost(type, resultId){
  setResult(resultId, 'å®Ÿè¡Œä¸­...', 'warn');
  try{
    const r = await fetch(GAS_URL, {
      method:'POST',
      redirect:'follow',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ type })
    });
    const text = await r.text();
    
    // JSON parse è©¦è¡Œ
    let json;
    try{ json = JSON.parse(text); }
    catch(e){
      setResult(resultId, `âŒ JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—\nãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${text.substring(0,150)}`, 'error');
      return;
    }
    
    if(json.success !== false && json.error == null){
      const count = json.articles?.length ?? json.publications?.length ?? json.members?.length ?? 'â€”';
      setResult(resultId, `âœ… æˆåŠŸ â€” ${typeof count === 'number' ? count+'ä»¶å–å¾—' : JSON.stringify(json).substring(0,80)}`);
    } else {
      setResult(resultId, `âŒ success:false ã¾ãŸã¯ error â€” ${JSON.stringify(json).substring(0,120)}`, 'error');
    }
  }catch(e){
    setResult(resultId, `âŒ fetchã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
  }
}

/* ===== OTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ===== */
async function testOtpRequest(){
  const name = document.getElementById('test-name').value.trim();
  const pw   = document.getElementById('test-pw').value.trim();
  if(!name||!pw){ setResult('r-otp-req','âŒ åå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'); return; }
  
  setResult('r-otp-req','å®Ÿè¡Œä¸­...','warn');
  try{
    const r = await fetch(GAS_URL, {
      method:'POST', redirect:'follow',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ type:'request', name, password:pw })
    });
    const json = await r.json();
    if(json.success){
      setResult('r-otp-req', `âœ… OTPé€ä¿¡æˆåŠŸï¼ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„`);
    } else if(json.error === 'invalid_credentials'){
      setResult('r-otp-req', `âŒ èªè¨¼å¤±æ•— â€” ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™\nâ€» users ã‚·ãƒ¼ãƒˆã®Aåˆ—(åå‰)ãƒ»Cåˆ—(ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰)ã‚’ç¢ºèª`, 'error');
    } else if(json.error === 'locked'){
      setResult('r-otp-req', `âš ï¸ ãƒ­ãƒƒã‚¯ä¸­ â€” æ®‹ã‚Š${json.remaining}åˆ†å¾Œã«å†è©¦è¡Œ`, 'warn');
    } else {
      setResult('r-otp-req', `âŒ ä¸æ˜ã‚¨ãƒ©ãƒ¼: ${JSON.stringify(json)}`, 'error');
    }
  }catch(e){
    setResult('r-otp-req', `âŒ fetchã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
  }
}

/* ===== OTP æ¤œè¨¼ ===== */
async function testOtpVerify(){
  const name = document.getElementById('test-name').value.trim();
  const otp  = document.getElementById('test-otp').value.trim();
  if(!name||!otp){ setResult('r-otp-verify','âŒ åå‰ã¨OTPã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'); return; }
  
  setResult('r-otp-verify','å®Ÿè¡Œä¸­...','warn');
  try{
    const r = await fetch(GAS_URL, {
      method:'POST', redirect:'follow',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ type:'verifyOTP', name, otp })
    });
    const json = await r.json();
    if(json.success && json.token){
      setResult('r-otp-verify', `âœ… èªè¨¼æˆåŠŸï¼ token=${json.token.substring(0,16)}...`);
    } else {
      const msg = {
        wrong_otp:'OTPã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™',
        expired:'æœ‰åŠ¹æœŸé™åˆ‡ã‚Œï¼ˆå†åº¦OTPé€ä¿¡ãŒå¿…è¦ï¼‰',
        no_otp:'OTPãŒç™ºè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆå…ˆã«OTPé€ä¿¡ã‚’ï¼‰'
      };
      setResult('r-otp-verify', `âŒ ${msg[json.error]||JSON.stringify(json)}`, 'error');
    }
  }catch(e){
    setResult('r-otp-verify', `âŒ fetchã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
  }
}

updateSummary();
</script>

</body>
</html>
